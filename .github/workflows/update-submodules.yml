name: Update Submodules

on:
  schedule:
    # Run every day at 02:00 UTC (can be adjusted)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true  # This will initialize and update submodules
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update submodules
      run: |
        git submodule update --remote --merge
        
        # Check if there are changes to commit
        if git diff --quiet HEAD; then
          echo "No submodule updates found"
          exit 0
        else
          echo "Submodule updates found, creating commit"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: update submodules to latest commits"
          
          # Create a new branch for the update
          BRANCH_NAME="update-submodules-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # Create pull request
          gh pr create \
            --title "ðŸ”„ Update submodules to latest commits" \
            --body "Automated submodule update

This PR updates the following submodules to their latest commits:
$(git submodule status --recursive | awk '{print "- " $2 " (" $1 ")"}')

Generated by GitHub Actions workflow 'Update Submodules'" \
            --base main \
            --head "$BRANCH_NAME"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup GitHub CLI
      if: always()
      run: |
        type gh >/dev/null 2>&1 || {
          echo "Installing GitHub CLI..."
          sudo apt-get update
          sudo apt-get install -y gh
        }